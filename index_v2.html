<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Figures of Speech Flashcards - myShakespeare.me</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .text-amber-900 a {
            text-decoration: underline;
            color: #78350f;
        }
        .text-amber-900 a:hover {
            color: #92400e;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Lucide React icons as inline SVG components
        const RotateCcw = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                <path d="M21 3v5h-5"/>
                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                <path d="M3 21v-5h5"/>
            </svg>
        );

        const Upload = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" x2="12" y1="3" y2="15"/>
            </svg>
        );

        const CheckCircle = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <path d="m9 12 2 2 4-4"/>
            </svg>
        );

        const XCircle = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <path d="m15 9-6 6"/>
                <path d="m9 9 6 6"/>
            </svg>
        );

        const BarChart3 = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M3 3v18h18"/>
                <path d="M18 17V9"/>
                <path d="M13 17V5"/>
                <path d="M8 17v-3"/>
            </svg>
        );

        const FileText = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <path d="M14 2v6h6"/>
                <path d="M16 13H8"/>
                <path d="M16 17H8"/>
                <path d="M10 9H8"/>
            </svg>
        );

        const Search = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.3-4.3"/>
            </svg>
        );

        const X = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M18 6 6 18"/>
                <path d="m6 6 12 12"/>
            </svg>
        );

        const ArrowDownAZ = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m3 16 4 4 4-4"/>
                <path d="M7 20V4"/>
                <path d="M20 8h-5"/>
                <path d="M15 10V6.5a2.5 2.5 0 0 1 5 0V10"/>
                <path d="M15 14h5l-5 6h5"/>
            </svg>
        );

        const Shuffle = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M2 18h1.4c1.3 0 2.5-.6 3.3-1.7l6.1-8.6c.7-1.1 2-1.7 3.3-1.7H22"/>
                <polyline points="18 2 22 6 18 10"/>
                <path d="M2 6h1.9c1.5 0 2.9.9 3.6 2.2"/>
                <polyline points="22 18 18 22 14 18"/>
                <path d="M22 18h-5.5c-1.3 0-2.6-.7-3.3-1.8l-.5-.8"/>
            </svg>
        );

        const ChevronLeft = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m15 18-6-6 6-6"/>
            </svg>
        );

        const ChevronRight = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m9 18 6-6-6-6"/>
            </svg>
        );

        // Helper function to clean WordPress shortcodes from descriptions
        function cleanWordPressShortcodes(text) {
            if (!text) return text;
            
            // Remove tooltip shortcodes: [tooltip title="..."]content[/tooltip] -> content
            text = text.replace(/\[tooltip[^\]]*\]([^\[]*?)\[\/tooltip\]/gi, '$1');
            
            return text;
        }

        // Fetch Shakespeare figures of speech from API with pagination support
        async function fetchShakespeareData() {
            try {
                let allData = [];
                let page = 1;
                let totalPages = 1;
                const perPage = 100;
                
                console.log('Starting API fetch with pagination...');
                
                // Fetch all pages
                while (page <= totalPages) {
                    const url = `https://myshakespeare.me/wp-json/wp/v2/figures_of_speech?per_page=${perPage}&page=${page}`;
                    console.log(`Fetching page ${page}/${totalPages}...`);
                    
                    const response = await fetch(url);
                    
                    // Check for pagination headers (WordPress REST API standard)
                    const totalPagesHeader = response.headers.get('X-WP-TotalPages');
                    if (totalPagesHeader && page === 1) {
                        totalPages = parseInt(totalPagesHeader, 10);
                        console.log(`Total pages available: ${totalPages}`);
                    }
                    
                    const data = await response.json();
                    
                    // Fallback: if no header and we get empty results, stop
                    if (!data || data.length === 0) {
                        console.log(`Page ${page} returned no results, stopping pagination`);
                        break;
                    }
                    
                    console.log(`Fetched ${data.length} items from page ${page}`);
                    allData = allData.concat(data);
                    page++;
                    
                    // Safety limit to prevent infinite loops
                    if (page > 20) {
                        console.warn('Reached safety limit of 20 pages, stopping');
                        break;
                    }
                }
                
                console.log(`Total items fetched from API: ${allData.length}`);
                
                // Convert API response to CSV format
                const rows = ['Name,Description'];
                let skipped = 0;
                allData.forEach((item, index) => {
                    const name = item.name || '';
                    // Keep HTML in description, just trim whitespace
                    let description = (item.description || '').trim();
                    
                    // Skip items with empty name or description
                    if (!name || !description) {
                        console.warn(`Skipping item ${index}: name="${name}", description length=${description.length}`);
                        skipped++;
                        return;
                    }
                    
                    // Filter out WordPress shortcodes
                    description = cleanWordPressShortcodes(description);
                    // Properly escape for CSV: wrap in quotes and escape internal quotes
                    const escapedDesc = `"${description.replace(/"/g, '""')}"`;
                    rows.push(`${name},${escapedDesc}`);
                });
                
                console.log(`Created CSV with ${rows.length - 1} cards (skipped ${skipped} items with missing data)`);
                return rows.join('\n');
            } catch (error) {
                console.error('Error fetching Shakespeare data:', error);
                // Fallback to empty data
                return 'Name,Description';
            }
        }

        function FlashcardApp() {
            const [cards, setCards] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);
            const [showStats, setShowStats] = useState(false);
            const [showImport, setShowImport] = useState(false);
            const [csvText, setCsvText] = useState('');
            const [initialized, setInitialized] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [filteredCards, setFilteredCards] = useState([]);
            const [displayMode, setDisplayMode] = useState('randomize'); // 'alphabetize' or 'randomize'

            useEffect(() => {
                loadProgress();
            }, []);

            useEffect(() => {
                if (searchTerm.trim() === '') {
                    setFilteredCards(cards);
                } else {
                    const term = searchTerm.toLowerCase();
                    const filtered = cards.filter(card => {
                        const nameText = card.name.toLowerCase();
                        const descElement = document.createElement('div');
                        descElement.innerHTML = card.description;
                        const descText = descElement.textContent.toLowerCase();
                        return nameText.includes(term) || descText.includes(term);
                    });
                    setFilteredCards(filtered);
                    if (filtered.length > 0 && currentIndex >= filtered.length) {
                        setCurrentIndex(0);
                        setIsFlipped(false);
                    }
                }
            }, [searchTerm, cards, currentIndex]);

            const loadProgress = async () => {
                try {
                    const saved = localStorage.getItem('flashcard-progress');
                    let savedProgress = saved ? JSON.parse(saved) : null;
                    
                    // Fetch fresh data from API
                    const apiData = await fetchShakespeareData();
                    const freshCards = parseCSV(apiData);
                    
                    // Restore progress for cards that existed before (match by name)
                    if (savedProgress && savedProgress.length > 0) {
                        const progressMap = new Map();
                        savedProgress.forEach(card => {
                            progressMap.set(card.name, {
                                status: card.status,
                                weight: card.weight,
                                lastReviewed: card.lastReviewed
                            });
                        });
                        
                        const restoredCards = freshCards.map(card => {
                            if (progressMap.has(card.name)) {
                                const progress = progressMap.get(card.name);
                                return { ...card, ...progress };
                            }
                            return card;
                        });
                        
                        setCards(restoredCards);
                        saveProgress(restoredCards);
                    } else {
                        setCards(freshCards);
                        saveProgress(freshCards);
                    }
                } catch (error) {
                    console.error('Error loading progress:', error);
                    setCards([]);
                }
                setIsLoading(false);
                setInitialized(true);
            };

            const saveProgress = (updatedCards) => {
                try {
                    localStorage.setItem('flashcard-progress', JSON.stringify(updatedCards));
                } catch (error) {
                    console.error('Error saving progress:', error);
                }
            };

            const parseCSV = (text) => {
                const lines = text.trim().split('\n');
                const headers = lines[0].split(',').map(h => h.trim().replace(/^["']|["']$/g, ''));
                
                const nameIndex = headers.findIndex(h => h.toLowerCase().includes('name'));
                const descIndex = headers.findIndex(h => h.toLowerCase().includes('description') || h.toLowerCase().includes('desc'));
                
                console.log(`parseCSV: Processing ${lines.length - 1} lines`);
                
                const parsedCards = [];
                let cardCounter = 0; // Counter to ensure unique IDs
                
                // Better CSV parsing that handles multi-line quoted fields
                let i = 1;
                while (i < lines.length) {
                    if (!lines[i].trim()) {
                        i++;
                        continue;
                    }
                    
                    let fullLine = lines[i];
                    
                    // Check if we're inside a quoted field that spans multiple lines
                    let quoteCount = (fullLine.match(/"/g) || []).length;
                    while (quoteCount % 2 !== 0 && i + 1 < lines.length) {
                        i++;
                        fullLine += '\n' + lines[i];
                        quoteCount = (fullLine.match(/"/g) || []).length;
                    }
                    
                    const values = [];
                    let currentValue = '';
                    let insideQuotes = false;
                    
                    for (let j = 0; j < fullLine.length; j++) {
                        const char = fullLine[j];
                        const nextChar = j + 1 < fullLine.length ? fullLine[j + 1] : null;
                        
                        if (char === '"' && nextChar === '"' && insideQuotes) {
                            // Escaped quote within quoted field: "" -> "
                            currentValue += '"';
                            j++; // Skip the next quote
                        } else if (char === '"') {
                            // Toggle quote state (field delimiter)
                            insideQuotes = !insideQuotes;
                        } else if (char === ',' && !insideQuotes) {
                            values.push(currentValue.trim());
                            currentValue = '';
                        } else {
                            currentValue += char;
                        }
                    }
                    values.push(currentValue.trim());
                    
                    let name = (values[nameIndex] || values[0] || '').replace(/^["']|["']$/g, '');
                    let description = (values[descIndex] || values[1] || '').replace(/^["']|["']$/g, '');
                    
                    // Note: Quotes are now properly preserved by the CSV parser above
                    // No need to unescape them again here
                    
                    // Filter out WordPress shortcodes from uploaded CSV as well
                    description = cleanWordPressShortcodes(description);
                    
                    if (name && description) {
                        parsedCards.push({
                            id: `${Date.now()}-${cardCounter++}-${Math.random().toString(36).substr(2, 9)}`,
                            name,
                            description,
                            status: 'new',
                            weight: 5,
                            lastReviewed: null
                        });
                    } else {
                        console.warn(`parseCSV: Skipping line ${i} - name="${name}", description="${description.substring(0, 50)}..."`);
                    }
                    
                    i++;
                }

                console.log(`parseCSV: Parsed ${parsedCards.length} cards from CSV`);
                return shuffleCards(parsedCards);
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const text = event.target.result;
                        const parsed = parseCSV(text);
                        setCards(parsed);
                        saveProgress(parsed);
                        setShowImport(false);
                        setCurrentIndex(0);
                        setIsFlipped(false);
                        setSearchTerm('');
                    };
                    reader.readAsText(file);
                }
            };

            const handlePasteCSV = () => {
                const parsed = parseCSV(csvText);
                setCards(parsed);
                saveProgress(parsed);
                setShowImport(false);
                setCurrentIndex(0);
                setIsFlipped(false);
                setCsvText('');
                setSearchTerm('');
            };

            const handleLoadDefault = async () => {
                setIsLoading(true);
                try {
                    const apiData = await fetchShakespeareData();
                    const parsed = parseCSV(apiData);
                    setCards(parsed);
                    saveProgress(parsed);
                    setShowImport(false);
                    setCurrentIndex(0);
                    setIsFlipped(false);
                    setSearchTerm('');
                } catch (error) {
                    console.error('Error loading default data:', error);
                }
                setIsLoading(false);
            };

            // Helper to deduplicate cards by ID
            const deduplicateCards = (cardList) => {
                return Array.from(new Map(cardList.map(card => [card.id, card])).values());
            };

            // Helper to find next unique card index (skips duplicates)
            const findNextUniqueIndex = (currentIdx, cardList) => {
                if (cardList.length === 0) return 0;
                const currentCard = cardList[currentIdx];
                let nextIdx = currentIdx + 1;
                
                // Wrap around to beginning if at end
                if (nextIdx >= cardList.length) {
                    nextIdx = 0;
                }
                
                // Skip duplicates of current card
                while (nextIdx !== currentIdx && cardList[nextIdx].id === currentCard.id) {
                    nextIdx++;
                    if (nextIdx >= cardList.length) {
                        nextIdx = 0;
                    }
                }
                
                return nextIdx;
            };

            // Helper to find previous unique card index (skips duplicates)
            const findPreviousUniqueIndex = (currentIdx, cardList) => {
                if (cardList.length === 0) return 0;
                const currentCard = cardList[currentIdx];
                let prevIdx = currentIdx - 1;
                
                // Wrap around to end if at beginning
                if (prevIdx < 0) {
                    prevIdx = cardList.length - 1;
                }
                
                // Skip duplicates of current card
                while (prevIdx !== currentIdx && cardList[prevIdx].id === currentCard.id) {
                    prevIdx--;
                    if (prevIdx < 0) {
                        prevIdx = cardList.length - 1;
                    }
                }
                
                return prevIdx;
            };

            const removeConsecutiveDuplicates = (cardList) => {
                const result = [];
                for (let i = 0; i < cardList.length; i++) {
                    if (i === 0 || cardList[i].id !== cardList[i - 1].id) {
                        result.push(cardList[i]);
                    }
                }
                return result;
            };

            const shuffleCards = (cardList) => {
                // First deduplicate to avoid multiplying already-weighted cards
                const uniqueCards = deduplicateCards(cardList);
                const weighted = [];
                uniqueCards.forEach(card => {
                    const weight = card.status === 'needs-review' ? card.weight * 3 : card.weight;
                    for (let i = 0; i < weight; i++) {
                        weighted.push(card);
                    }
                });
                
                for (let i = weighted.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [weighted[i], weighted[j]] = [weighted[j], weighted[i]];
                }
                
                // Remove consecutive duplicates before returning
                const shuffledWithoutConsecutiveDupes = removeConsecutiveDuplicates(weighted.map(card => ({ ...card })));
                return shuffledWithoutConsecutiveDupes;
            };

            const markCard = (status) => {
                if (filteredCards.length === 0) return;

                const currentCard = filteredCards[currentIndex];
                const updatedCards = cards.map(card => {
                    if (card.id === currentCard.id) {
                        return {
                            ...card,
                            status,
                            weight: status === 'known' ? Math.max(1, card.weight - 1) : 
                                   status === 'needs-review' ? Math.min(10, card.weight + 1) : card.weight,
                            lastReviewed: new Date().toISOString()
                        };
                    }
                    return card;
                });

                setCards(updatedCards);
                saveProgress(updatedCards);
                
                setIsFlipped(false);
                
                // Update filteredCards to reflect the changes
                const updatedFilteredCards = searchTerm.trim() === '' ? updatedCards : filteredCards.map(fc => {
                    const updated = updatedCards.find(uc => uc.id === fc.id);
                    return updated || fc;
                });
                
                // Move to next unique card (only in alphabetize mode) or next card (in randomize mode)
                let nextIdx;
                if (displayMode === 'alphabetize') {
                    nextIdx = findNextUniqueIndex(currentIndex, updatedFilteredCards);
                } else {
                    // In randomize mode, just move to next index
                    nextIdx = currentIndex + 1;
                }
                
                // If at end of deck in randomize mode and not searching, reshuffle
                if (nextIdx >= updatedFilteredCards.length && displayMode === 'randomize' && searchTerm.trim() === '') {
                    const uniqueCards = deduplicateCards(updatedCards);
                    const reshuffled = shuffleCards(uniqueCards);
                    setCards(reshuffled);
                    saveProgress(reshuffled);
                    setCurrentIndex(0);
                } else if (nextIdx === currentIndex && searchTerm.trim() === '') {
                    // Fallback: if we're back at the same position, reshuffle
                    const uniqueCards = deduplicateCards(updatedCards);
                    const reshuffled = shuffleCards(uniqueCards);
                    setCards(reshuffled);
                    saveProgress(reshuffled);
                    setCurrentIndex(0);
                } else if (nextIdx >= updatedFilteredCards.length) {
                    // Wrap to beginning if at end
                    setCurrentIndex(0);
                } else {
                    setCurrentIndex(nextIdx);
                }
            };

            const resetProgress = async () => {
                setIsLoading(true);
                try {
                    const apiData = await fetchShakespeareData();
                    const parsed = parseCSV(apiData);
                    setCards(parsed);
                    saveProgress(parsed);
                    setCurrentIndex(0);
                    setIsFlipped(false);
                    setShowStats(false);
                    setSearchTerm('');
                } catch (error) {
                    console.error('Error resetting progress:', error);
                }
                setIsLoading(false);
            };

            const alphabetizeCards = () => {
                // Deduplicate first, then sort alphabetically - NO WEIGHTING in alphabetize mode
                const uniqueCards = deduplicateCards(cards);
                const sorted = [...uniqueCards].sort((a, b) => a.name.localeCompare(b.name));
                
                setCards(sorted);
                saveProgress(sorted);
                setDisplayMode('alphabetize');
                setCurrentIndex(0);
                setIsFlipped(false);
            };

            const randomizeCards = () => {
                // Deduplicate first to prevent multiplication
                const uniqueCards = deduplicateCards(cards);
                const reshuffled = shuffleCards(uniqueCards);
                setCards(reshuffled);
                saveProgress(reshuffled);
                setDisplayMode('randomize');
                setCurrentIndex(0);
                setIsFlipped(false);
            };

            // Use deduplicated cards for stats and display counts
            const uniqueCards = deduplicateCards(cards);
            const uniqueFilteredCards = deduplicateCards(filteredCards);
            const stats = uniqueCards.reduce((acc, card) => {
                acc.total++;
                if (card.status === 'known') acc.known++;
                if (card.status === 'needs-review') acc.needsReview++;
                if (card.status === 'new') acc.new++;
                return acc;
            }, { total: 0, known: 0, needsReview: 0, new: 0 });

            if (!initialized || isLoading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-50 flex items-center justify-center p-8">
                        <div className="text-center">
                            <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-amber-600 mb-4"></div>
                            <p className="text-xl text-amber-800">Loading flashcards...</p>
                        </div>
                    </div>
                );
            }

            if (showImport) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-50 p-8">
                        <div className="max-w-2xl mx-auto">
                            <div className="bg-white rounded-xl shadow-lg p-8 border-2 border-amber-200">
                                <h2 className="text-3xl font-bold text-amber-900 mb-6 flex items-center">
                                    <Upload className="w-8 h-8 mr-3" />
                                    Import Flashcards
                                </h2>

                                <div className="space-y-6">
                                    <div>
                                        <h3 className="text-xl font-semibold text-amber-800 mb-3">Load Default Dataset</h3>
                                        <p className="text-gray-600 mb-4">Load Shakespeare's Figures of Speech from MyShakespeare.me</p>
                                        <button
                                            onClick={handleLoadDefault}
                                            className="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white py-3 px-6 rounded-lg hover:from-amber-600 hover:to-orange-600 transition font-medium"
                                        >
                                            Load Shakespeare Vocabulary
                                        </button>
                                    </div>

                                    <div className="border-t-2 border-amber-100 pt-6">
                                        <h3 className="text-xl font-semibold text-amber-800 mb-3">Upload CSV File</h3>
                                        <input
                                            type="file"
                                            accept=".csv"
                                            onChange={handleFileUpload}
                                            className="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-amber-50 file:text-amber-700 hover:file:bg-amber-100"
                                        />
                                    </div>

                                    <div className="border-t-2 border-amber-100 pt-6">
                                        <h3 className="text-xl font-semibold text-amber-800 mb-3">Paste CSV Data</h3>
                                        <textarea
                                            value={csvText}
                                            onChange={(e) => setCsvText(e.target.value)}
                                            placeholder="Name,Description&#10;React,A JavaScript library for building user interfaces&#10;Python,A high-level programming language"
                                            className="w-full h-40 px-4 py-2 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                                        ></textarea>
                                        <button
                                            onClick={handlePasteCSV}
                                            className="mt-4 w-full bg-amber-600 text-white py-3 px-6 rounded-lg hover:bg-amber-700 transition"
                                        >
                                            Import Custom Flashcards
                                        </button>
                                    </div>

                                    <div className="text-sm text-gray-600 bg-gray-50 p-4 rounded-lg">
                                        <p className="font-medium mb-2">Expected CSV format:</p>
                                        <p>First row: Column headers (must include "Name" and "Description")</p>
                                        <p>Following rows: Your flashcard data</p>
                                    </div>
                                </div>

                                <button
                                    onClick={() => setShowImport(false)}
                                    className="mt-6 w-full bg-gray-500 text-white py-3 px-6 rounded-lg hover:bg-gray-600 transition"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (showStats) {
                const progress = stats.total > 0 ? Math.round((stats.known / stats.total) * 100) : 0;
                
                return (
                    <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-50 p-8">
                        <div className="max-w-2xl mx-auto">
                            <div className="bg-white rounded-xl shadow-lg p-8 border-2 border-amber-200">
                                <h2 className="text-3xl font-bold text-amber-900 mb-6 flex items-center">
                                    <BarChart3 className="w-8 h-8 mr-3" />
                                    Your Progress
                                </h2>

                                <div className="mb-8">
                                    <div className="flex justify-between text-sm text-amber-800 mb-2">
                                        <span>Overall Progress</span>
                                        <span className="font-bold">{progress}%</span>
                                    </div>
                                    <div className="w-full bg-amber-100 rounded-full h-4">
                                        <div
                                            className="bg-gradient-to-r from-amber-500 to-orange-500 h-4 rounded-full transition-all duration-500"
                                            style={{ width: `${progress}%` }}
                                        ></div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-4 mb-8">
                                    <div className="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-lg border-2 border-green-200">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-green-800 font-semibold">Known</span>
                                            <CheckCircle className="w-6 h-6 text-green-600" />
                                        </div>
                                        <div className="text-3xl font-bold text-green-900">{stats.known}</div>
                                    </div>

                                    <div className="bg-gradient-to-br from-red-50 to-red-100 p-6 rounded-lg border-2 border-red-200">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-red-800 font-semibold">Needs Review</span>
                                            <XCircle className="w-6 h-6 text-red-600" />
                                        </div>
                                        <div className="text-3xl font-bold text-red-900">{stats.needsReview}</div>
                                    </div>

                                    <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-lg border-2 border-blue-200">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-blue-800 font-semibold">New</span>
                                            <FileText className="w-6 h-6 text-blue-600" />
                                        </div>
                                        <div className="text-3xl font-bold text-blue-900">{stats.new}</div>
                                    </div>

                                    <div className="bg-gradient-to-br from-amber-50 to-amber-100 p-6 rounded-lg border-2 border-amber-200">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-amber-800 font-semibold">Total</span>
                                            <BarChart3 className="w-6 h-6 text-amber-600" />
                                        </div>
                                        <div className="text-3xl font-bold text-amber-900">{stats.total}</div>
                                    </div>
                                </div>

                                <div className="space-y-3">
                                    <button
                                        onClick={() => setShowStats(false)}
                                        className="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white py-3 px-6 rounded-lg hover:from-amber-600 hover:to-orange-600 transition font-medium"
                                    >
                                        Continue Studying
                                    </button>
                                    <button
                                        onClick={() => { setShowImport(true); setShowStats(false); }}
                                        className="w-full bg-amber-600 text-white py-3 px-6 rounded-lg hover:bg-amber-700 transition"
                                        style={{ display: 'none' }}
                                    >
                                        Import New Cards
                                    </button>
                                    <button
                                        onClick={resetProgress}
                                        className="w-full bg-gray-500 text-white py-3 px-6 rounded-lg hover:bg-gray-600 transition flex items-center justify-center"
                                    >
                                        <RotateCcw className="w-5 h-5 mr-2" />
                                        Reset All Progress
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (cards.length === 0) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-50 flex items-center justify-center p-8">
                        <button onClick={() => setShowImport(true)} className="text-xl text-amber-800 underline">
                            Load flashcards to begin
                        </button>
                    </div>
                );
            }

            const currentCard = filteredCards.length > 0 ? filteredCards[currentIndex] : null;

            return (
                <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-50 p-8">
                    <div className="max-w-2xl mx-auto">
                        <div className="mb-6">
                            <div className="flex justify-between items-start">
                                <div>
                                    <h1 className="text-3xl font-bold text-amber-900" style={{ fontFamily: 'Papyrus, fantasy' }}>ðŸ“š Figures of Speech Flashcards</h1>
                                    <a 
                                        href="https://myshakespeare.me" 
                                        target="_blank" 
                                        rel="noopener noreferrer"
                                        className="text-sm text-amber-700 underline hover:text-amber-900"
                                    >
                                        myShakespeare.me
                                    </a>
                                </div>
                                <div className="flex flex-col gap-2">
                                    <button
                                        onClick={() => {
                                            setShowStats(true);
                                            setSearchTerm('');
                                        }}
                                        className="bg-white px-4 py-2 rounded-lg shadow hover:shadow-md transition flex items-center gap-2"
                                    >
                                        <BarChart3 className="w-5 h-5" />
                                        Stats
                                    </button>
                                    <button
                                        onClick={() => {
                                            setShowImport(true);
                                            setSearchTerm('');
                                        }}
                                        className="bg-white px-4 py-2 rounded-lg shadow hover:shadow-md transition flex items-center gap-2"
                                        style={{ display: 'none' }}
                                    >
                                        <Upload className="w-5 h-5" />
                                        Import
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="mb-4 flex flex-wrap gap-2 items-center">
                            <button
                                onClick={alphabetizeCards}
                                className="bg-white px-4 py-2 rounded-lg shadow hover:shadow-md transition flex items-center gap-2"
                            >
                                <ArrowDownAZ className="w-5 h-5" />
                                Alphabetize
                            </button>
                            <button
                                onClick={randomizeCards}
                                className="bg-white px-4 py-2 rounded-lg shadow hover:shadow-md transition flex items-center gap-2"
                            >
                                <Shuffle className="w-5 h-5" />
                                Randomize
                            </button>
                            <div className="relative flex-1 max-w-sm">
                                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-amber-600 w-5 h-5" />
                                <input
                                    type="text"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    placeholder="Search flashcards..."
                                    className="w-full pl-10 pr-10 py-2 border-2 border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                                />
                                {searchTerm && (
                                    <button
                                        onClick={() => setSearchTerm('')}
                                        className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-amber-600"
                                    >
                                        <X className="w-5 h-5" />
                                    </button>
                                )}
                            </div>
                        </div>

                        {searchTerm && (
                            <div className="text-sm text-amber-700 mb-4">
                                Found {uniqueFilteredCards.length} card{uniqueFilteredCards.length !== 1 ? 's' : ''}
                            </div>
                        )}

                        {filteredCards.length === 0 ? (
                            <div className="bg-white rounded-xl shadow-lg p-12 text-center border-2 border-amber-200">
                                <Search className="w-16 h-16 text-amber-300 mx-auto mb-4" />
                                <h3 className="text-xl font-semibold text-amber-900 mb-2">No cards found</h3>
                                <p className="text-gray-600">Try a different search term</p>
                            </div>
                        ) : (
                            <>
                                <div className="bg-white rounded-xl shadow-lg p-8 mb-6 border-2 border-amber-200">
                                    <div className="text-sm text-gray-500 mb-4">
                                        {displayMode === 'alphabetize' ? (
                                            <span>Card {uniqueFilteredCards.findIndex(uc => uc.id === (filteredCards[currentIndex]?.id)) + 1} of {uniqueFilteredCards.length}</span>
                                        ) : (
                                            <span style={{ display: 'none' }} className="italic text-amber-700">Studying with spaced repetition for optimal learning</span>
                                        )}
                                    </div>

                                    <div
                                        onClick={() => setIsFlipped(!isFlipped)}
                                        className="min-h-64 flex items-center justify-center cursor-pointer bg-gradient-to-br from-amber-100 to-orange-100 rounded-lg p-8 mb-6 hover:from-amber-200 hover:to-orange-200 transition"
                                    >
                                        <div className="text-center w-full">
                                            {!isFlipped ? (
                                                <div className="text-2xl font-bold text-amber-900">{filteredCards[currentIndex].name}</div>
                                            ) : (
                                                <div 
                                                    className="text-xl text-amber-900"
                                                    style={{ lineHeight: '1.6' }}
                                                    dangerouslySetInnerHTML={{ __html: filteredCards[currentIndex].description }} 
                                                />
                                            )}
                                        </div>
                                    </div>

                                    <div className="text-center text-sm text-gray-500 mb-4">
                                        Click card to flip
                                    </div>

                                    {isFlipped && (
                                        <div className="flex gap-4 mb-4">
                                            <button
                                                onClick={() => markCard('needs-review')}
                                                className="flex-1 bg-amber-500 text-white py-4 px-6 rounded-lg hover:bg-amber-600 transition flex items-center justify-center gap-2 font-semibold"
                                            >
                                                <XCircle className="w-5 h-5" />
                                                Needs Review
                                            </button>
                                            <button
                                                onClick={() => markCard('known')}
                                                className="flex-1 bg-amber-600 text-white py-4 px-6 rounded-lg hover:bg-amber-700 transition flex items-center justify-center gap-2 font-semibold"
                                            >
                                                <CheckCircle className="w-5 h-5" />
                                                I Know This
                                            </button>
                                        </div>
                                    )}
                                    
                                    <div className="flex gap-4">
                                        <button
                                            onClick={() => {
                                                setIsFlipped(false);
                                                if (displayMode === 'alphabetize') {
                                                    const prevIdx = findPreviousUniqueIndex(currentIndex, filteredCards);
                                                    setCurrentIndex(prevIdx);
                                                } else {
                                                    // In randomize mode, simple decrement with wrap
                                                    const prevIdx = currentIndex > 0 ? currentIndex - 1 : filteredCards.length - 1;
                                                    setCurrentIndex(prevIdx);
                                                }
                                            }}
                                            className="flex-1 bg-amber-800 text-white py-3 px-6 rounded-lg hover:bg-amber-900 transition flex items-center justify-center gap-2"
                                        >
                                            <ChevronLeft className="w-5 h-5" />
                                            Previous Card
                                        </button>
                                        <button
                                            onClick={() => {
                                                setIsFlipped(false);
                                                if (displayMode === 'alphabetize') {
                                                    const nextIdx = findNextUniqueIndex(currentIndex, filteredCards);
                                                    setCurrentIndex(nextIdx);
                                                } else {
                                                    // In randomize mode, move forward and reshuffle if at end
                                                    if (currentIndex >= filteredCards.length - 1) {
                                                        // Reshuffle at end of deck
                                                        const uniqueCards = deduplicateCards(cards);
                                                        const reshuffled = shuffleCards(uniqueCards);
                                                        setCards(reshuffled);
                                                        saveProgress(reshuffled);
                                                        setCurrentIndex(0);
                                                    } else {
                                                        setCurrentIndex(currentIndex + 1);
                                                    }
                                                }
                                            }}
                                            className="flex-1 bg-amber-800 text-white py-3 px-6 rounded-lg hover:bg-amber-900 transition flex items-center justify-center gap-2"
                                        >
                                            Next Card
                                            <ChevronRight className="w-5 h-5" />
                                        </button>
                                    </div>
                                </div>

                                <div className="bg-white rounded-lg shadow p-4 border-2 border-amber-200">
                                    <div className="flex justify-between text-sm">
                                        <span className="text-amber-700">âœ“ Known: {stats.known}</span>
                                        <span className="text-orange-700">âš  Review: {stats.needsReview}</span>
                                        <span className="text-amber-700">â— New: {stats.new}</span>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<FlashcardApp />, document.getElementById('root'));
    </script>
</body>
</html>
